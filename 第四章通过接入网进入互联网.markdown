[TOC]

# 第四章 通过接入网进入互联网内部

## 4.1 ADSL接入网的结构和工作方式

### 4.1.1 互联网的基本结构

互联网的基本结构和家庭，公司网络是相同的。距离不同和路由的维护方式，是互联网和家庭公司网络的不同。

### 4.1.2  连接用户与互联网的接入网

网络包通过互联网接入路由器之后进行了互联网，互联网接入路由器是按照接入网的规则来发送包的。

接入网就是指连接互联网与家庭，公司网络的通信线路，一般家用接入网的方式包括ADSL，FTTH，CATV，电话线，ISDN等。

### 4.1.3 ADSL Modem 将包拆分成信元

用户端路由器发送出来的网络包通过ADSL Modem和电话线到达电话局，然后到达ADSL的网络运营商。

首先，客户端生成的网络包经过集线器和交换机到达互联网接入路由器，互联网接入路由器会在网络包前面加上MAC头部，PPPoE头部，PPP头部总共三种头部，然后发送给ADSL Modem。ADSL Modem将包拆分成信元，用于一种叫做ATM的通信技术，并转换成电信号发送给分离器。

ADSL会持续检查线路质量，Modem通电之后，会发送测试信号，并根据信号的接收情况判断使用的频段数量和每个频段的比特数，这个过程称为训练。

### 4.1.6 分离器的作用

ADSL信号会和电话的语音信号混合起来一起从电话线传输出去。

分离器的功能是将一定频率以上的电信号过滤掉，过滤掉ADSL频率高的信号，这样一来就只有电话信号才会传入电话机，但对于另一头的ADSL Modem，则是传输原本的混合信号给它。

### 4.1.7 从用户到电话局

从分离器出来之后，就是插电话线的接口，信号从这里出来之后，会通过室内电话线，然后到达大楼的IDF和MDF，外面的电话线在这里和大楼内部的室内电话线相连接。

接下来，信号会进入电线杆上假设的电话电缆，电话电缆会连接到电话局的MDF上。

### 4.1.9 通过DSLAM到达BAS

信号到电话局之后，会到达DSLAM(实际上是多个ADSL Modem整合在一起)，电信号被还原成数字信息（信元），这一过程和用户端的ADSL Modem接收数据的时候过程是一样的。

用户端的ADSL具有以太网接口，DSLAM不用以太网接口，而是ATM接口，和之后的路由器收发数据的时候使用的是原始网络包拆分后的ATM信元形式。

信元从DSLAM出来之后，会到达一个叫做BAS的包转发设备。BAS和DSLAM一样都具有ATM接口，可以接受ATM信号，还可以将ATM信元还原成原始包，接下来，会将收到的包前面的MAC头部和PPPoE头部丢弃，取出PPP头部以及后面的数据。前两个头部的目的是将包送达BAS接口。

BAS会在包的前面加上隧道专用头部，发送到隧道的出口，网络包会到达隧道专用路由器，在这里隧道头部会被去掉，IP包被取出，被转发到互联网内部。

## 4.2 光纤接入网（FTTH）

## 4.3 接入网中使用的PPP和隧道

### 4.3.1 用户认证和配置下发

用户发送的网络包会通过ADSL和FTTH等接入网到达运营商的BAS。

首先是用户认证和配置下发功能。ADSL和FTTH接入网中，都需要先输入用户名和密码，登录之后才能访问互联网，BAS就是登录操作的窗口。BAS使用PPPoE方式来实现这一个功能。

使用电话线或者ISDN拨号上网时，首先用户向运营商的接入点拨打电话，电话接通之后，输入用户名和密码进行登录操作，用户名和密码通过RADIUS协议从RAS发送到认证服务器，认证服务器校验这些信息是否正确。当确认无误之后，认证服务器会返回IP地址等配置信息，并将这些信息下发给用户。用户的计算机根据这些信息配置IP地址等参数，完成TCP/IP收发网络包的准备工作。

接入互联网的时候必须给计算机分配一个公有地址，这个地址并不是事先确定的。

### 4.3.2 在以太网上传输PPP消息

PPPoE是将PPP消息装入以太网包进行传输的方式。

### 4.3.3 通过隧道将网络包发送给运营商

BAS除了作为用户认证的窗口之外，还可以使用隧道方式来传输网络包。

隧道就是类似于套接字之间建立的TCP连接。

### 4.3.4 接入网的整体工作过程

互联网路由器通过PPPoE的发现机制查询BAS的MAC地址。

BAS下发的TCP/IP参数会被配置到互联网接入路由器的BAS端端口上，这样路由器就完成了接入互联网的准备工作了。

BAS在收到用户路由器发送的网络包之后，会去掉MAC头部和PPPoE头部，然后用隧道机制将包发送给网络运营商的路由器。

### 4.3.5 不分配IP地址 的无编号端口

一对一连接的端口可以不分配IP地址，这种方式称为无编号

### 4.3.6 互联网接入路由器将私有地址转换成公有地址

BAS下发的配置信息配置在路由器上，路由器由公有地址，计算机会被分配一个私有地址。

上网的计算机如果有公有地址，那么就意味着来自互联网的包可以直接到达计算机，所以需要安装防火墙软件等防御手段。

## 4.4 网络运营商内部

### 4.4.1 POP和NOC

互联网的实体并不是一个组织运营管理的单一网络，而是由多个运营商网络相互连接组成的。ADSL和FTTH等接入网是与用户签约的运营商设备相连的，这些设备称为POP（Point of Presence），互联网的入口就位于这里。

POP的结构根据接入网类型以及运营商的业务类型不同而不同，意思就是根据接入网的类型分别使用不同的路由器。

还需要路由器连接POP和运营商的核心设备NOC（Network Operation Center），从POP传来的网络包都会集中到这里，并从这里转发到离目的地更近的POP，或者是转发到其他运营商。

POP和NOC没有明确的界限，NOC里也可以配备连接接入网的路由器。可以简单认为NOC就是规模扩大的POP。

## 4.5 跨越运营商的网络包

### 4.5.1 运营商之间的选择

网络到达POP之后，如果POP和目标服务器是在同一个网络运营商内的，那么POP路由器中会有相关转发目标，运营商的路由器可以和其他路由器交换路由信息，从而自动更新自己的路由表，实现路由信息的自动化管理。POP路由器会将包转发出去，目标可能是POP也可能是NOC，几次转发之后，网络包就到达了web服务器所在的POP路由器，然后被转发到Web服务器。

如果服务器的运营商和客户端的运营商不一样怎么办？需要先把包发送到服务器的运营商，因为运营商之间也存在着路由信息的交换，可以认为路由表中能找到对方运营商的路由信息。

### 4.5.2 运营商之间路由交换

互联网内部使用BGP机制在运营商之间交换路由信息。

交换路由信息可以分为两类，第一类叫做转接，就是将互联网中的路由全部告知对方，对方不仅可以访问我们运营商，还可以访问和我们相连的其他运营商；第二类是对等，也就是仅可以访问我们运营商。

### 4.5.3 与公司网络中自动更新路由表机制的区别

路由器之间相互交换信息自动更新路由表的方式在公司网络中 也会用到，不过公司内部和运营商之间在路由交换上是有区别的。

 公司按照的是寻找与目的地之间的最短路由，并按照最短路由来转发包，因此，所有路由器都是平等对待的。

如果互联网中也这样，就无法阻挡没有缴费的运营商使用这条线路，运营期之间的路由信息交换是在特定的一对一的路由器中进行的，这样运营商就可以把路由信息提供给那些交了费的运营商。

### 4.5.4 IX(Internet Exchange)

通过连接到中心设备的方式来减少线路数量，这个中心设备就叫做IX。

IX的核心是具有大量高速以太网接口的二层交换机。

二层交换机的基本原理和一般交换机相同。