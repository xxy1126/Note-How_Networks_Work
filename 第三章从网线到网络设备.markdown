# 第三章 从网线到网络设备

**探索集线器，交换机和路由器**

## 目标

1. 信号如何在网线和集线器中传输？如何抑制噪声干扰等在传输过程中的影响因素？
2. 交换机的工作方式
3. 路由器的工作方式以及和交换机的差异
4. 路由器的附加功能

## 3.1 信号在网线和集线器中传输

### 3.1.1 每个包都是独立传输的

从计算机发送出来的网络包会通过集线器，路由器等设备转发，最终到达目的地。转发设备会根据包头部中的控制信息，在转发设备内部一个写有转发规则的表中进行查询，以此来判断包的目的地。所有包在传输到目的地的过程中都是独立的。

网络包从客户端计算机发出之后，要经过集线器，交换机，路由器最终进入互联网。实际上，我们家里用的路由器已经集成了集线器和交换机的功能（？）。

### 3.1.2 防止网线中的信号衰减很重要

网卡中的PHY(MAU)模块负责将包转换成电信号。以太网信号的本质是正负变化的电压。可以认为PHY模块就是一个从正负两个信号端输出信号的电路。

信号会通过网线到达集线器接口，信号在网线传输过程中，能量会逐渐消失。网线越长，信号衰减越严重。

以太网中信号波形是方形，但能量损失会让信号的拐角变圆，这是因为电信号的频率越高，能量的损失率越大，信号的拐角意味着电压发生剧烈的变化。即使线路条件很好，信号在传输过程中依然会发生失真，再加上噪声的影响，本来已经衰减的信号再进一步失真，就会出现对01的误判，这就是产生通信错误的原因。

### 3.1.3 “双绞”是为了抑制噪声

### 3.1.4 集线器将信号发往所有线路

以太网的基本架构就是将包发送到所有的设备，然后由设备根据接收方的MAC地址来判断应该接收哪些包，集线器负责按照以太网的基本架构将信号广播出去。

**关于MDI/MDI-X（Media Dependent Interface媒体相关接口/Media Dependent Interface - Crossover）：**

在不使用交叉网线的时候，两个集线器必须一个MDI，一个MDI-X。如果集线器上没有MDI转换开关，而且所有接口都是MDI-X的时候，可以用交叉网线连接两台集线器。所谓交叉网线，就是一张将发送和接收信号线反过来接的网线。

交叉网线可以用于将两台计算机直接连接起来，只要将一侧的发送信号和另一侧的接收信号连接起来就可以收发数据了。

信号到达集线器的PHY模块后，会进入中继电路。中继电路的功能就是将输入的信号广播到集线器的所有端口上。

接下来，信号从所有接口流出，到达连接在集线器上的所有设备，然后这些设备在收到信号之后会通过MAC头部的接收方MAC地址判断是不是发给自己的，这样网络包就可以到达指定MAC地址的接收方。

网络包的错误由TCP模块负责，其他的只要负责自己的工作就行。

## 3.2 交换机的包转发操作

### 3.2.1 交换机根据地址表进行转发

交换机的设计是将网络包原样转发到目的地。

首先，信号到达网线接口，并由PHY模块进行接收，这一部分和集线器是相同的，接下来PHY会将网线中的信号转换为通用格式，然后传递给MAC模块。MAC模块将信号转换为数字信息，然后通过包末尾的FCS校验错误，没有问题就放到缓冲区中。和网卡操作类似，可以理解成每一个接口后面都有一个网卡，但是交换机接口不存在MAC地址。

将包放进缓存区中，要查询这个包接收方的MAC地址是否已经在MAC地址表中有记录了。

MAC地址表主要包含两个信息，一个是设备的MAC地址，另一个是该设备连接在交换机的哪个端口上，MAC地址和端口是一一对应的，就可以通过交换电路将包发送到相应的端口。

交换电路可以将输入端和输出端连接起来，信号线排成网格状，每一个交叉点都有一个交换开关，交换开关是电子控制的，通过切换开关的状态可以改变信号的流向。每个交换点上的开关都可以独立工作，因此只要路径不重复，就可以同时传输多路信号。当网络包通过交换电路到达发送端口的时候，端口中的MAC模块和PHY模块执行发送操作还有检测有没有其他设备在发送信号，这几步和网卡一样。

### 3.2.2 MAC地址表的维护

维护分为两种 

- 第一种是收到包之后，将发送方的MAC地址以及其输入端口的号码写入MAC地址表中，只要某个设备发送过网络包，那么它的MAC地址就会被记录。
- 另一种是删除地址表中某条记录的操作，地址表的记录不能永久保存而是要在一段时间不用后进行删除，避免信息改变引发的错误。

### 3.2.3 特殊操作

- 当交换机发现一个包要返回原端口的时候，就会直接丢弃这个包。
- 当MAC地址表中没有记录指定的MAC地址的时候，说明这个地址可能没有发送过包，交换机只能将包转发到除了源端口之外的所有端口上，无论该设备连接在哪个端口上。发送了包之后目标设备会做出响应，只要返回了响应包，交换机就可以将它的地址写入地址表。
- 如果接收方MAC地址是广播地址（MAC地址为FF:FF:FF:FF:FF:FF或者IP地址为255.255.255.255），那么交换机就会把包发送到除了源端口的所有端口。

### 3.2.4 全双工模式

全双工模式可以同时进行发送和接收操作，是交换机特有的工作模式。

使用集线器的时候，如果多台计算机同时发送信号，信号就会在集线器内部混杂在一起，进而无法使用，这种方式被称为碰撞，是以太网的一个重要特征，不过只要不用集线器，就不会发生碰撞。

以太网规范中规定了在网络中有信号时要等该信号结束后再发送信号，因此发送和接收还是无法同时进行。

于是进行了修订，增加了一个无论网络中有没有信号都可以发送信号的工作模式，同时规定在这一工作模式下停用碰撞检测，这种工作模式就是全双工模式。

### 3.2.5 自动协商：确定最优的传输效率

自动切换工作模式采用自动协商来判断是否切换工作模式。

在以太网中，当没有数据填充的时候，网络中会被填充一种被称为连接脉冲的脉冲信号，以太网设备的网线接口旁边有一个绿色的LED指示灯，如果绿灯亮，说明PHY模块以及网线连接正常。

后来，人们设计出具有特定排列的脉冲信号，通过这种信号可以将自身的状态告知对方。自动协商功能就是利用了这样的脉冲信号，通过这种信号将自己能够支持的工作模式和传输速率相互告知对方，并从中选择一个最优组合。

### 3.2.6 交换机可同时执行多个转发操作

## 3.3 路由器的包转发操作

### 3.3.1 路由器的基本知识

网络到达交换机之后，被转发到下一个路由器。路由器是基于IP设计的，交换机是基于以太网设计的。

路由器包括转发模块和端口模块两部分，转发模块负责判断包的转发目的地，端口模块负责包的转发，二者的关系相当于协议栈和网卡。

路由器的端口模块支持除局域网之外的多种通信技术，如ADSL，FTTH，以及各种宽带专线，只要端口模块安装了支持这些技术的硬件即可。**路由器的各个端口都具有MAC地址和IP地址**。

交换机只是将进来的包转发出去，而路由器是接收发给自己的以太网包，然后查询转发目标，再由相应的端口作为发送房将以太网包发送出去。

### 3.3.2 路由表中的信息

路由器中的表叫做路由表，路由器根据IP地址判断转发目标。

最左侧的目标地址记录的是接收方的信息，实际上这里的IP地址质包含表示子网的网络号部分的比特值，而表示主机号部分的比特值全部为0。交换机在地址表中只匹配完全一致的记录，而路由器则会忽略主机号部分。

在匹配地址过程中，路由器需要知道网络号的比特数，因此路由表中还有一列子网掩码。

目标地址列中的IP地址表示的是子网，但是有时候地址本身的子网掩码和路由表中的子网掩码是不一样的，这是**路由聚合**的效果。经过路由聚合，多个子网被合并成一个子网，子网掩码会发生变化，同时，目标地址列也会改成聚合后的地址。从结果上看，路由表中的子网掩码只是用来匹配目标地址时告诉路由器应该匹配多少个比特。

子网掩码的右边还有网关和接口两列，他们表示网络包的转发目标，根据目标地址和子网掩码匹配到记录后，路由器就会将网络包交给接口列中指定的网络接口（端口），并转发到网关列中指定的IP地址。

最后一点是跃点计数，他表示距离目标IP地址的距离远近，数字越小，表示距离目的地越近。

对路由表的维护：

- 人手动维护路有记录
- 根据路由协议机制，通过路由器之间的信息交换由路由器自行维护路由表的记录。

### 3.3.3 路由器的包接收操作

路由器的端口具有MAC地址，只接收与自身地址匹配的包，遇到不匹配的直接丢弃。

### 3.3.4 查询路由表确定输出端口

完成包的接收操作之后，路由器就会丢弃包开头的MAC头部。

接下来，路由器会根据MAC头部后方的IP头部内容进行包的转发操作，转发操作分为几个阶段，首先是查询路由表判断转发目标。

根据上面的规则，可能匹配到很多个，路由器首先寻找网络号比特数最长的一条记录，网络号比特数越长，说明主机号越短，子网内可分配的主机数量越少，为的是缩小范围转发目标更加准确。网络号长度相同的时候，就根据跃点数来判断。

如果路由表中没有相应的信息，就丢弃这一个包（处理方式和交换机不一样，因为网络规格不同），通过ICMP消息告知对方。

### 3.3.5 找不到匹配路由时选择默认路由

存在一行的子网掩码为0.0.0.0也就是要匹配的比特数为0，就是所有的ip地址都可以匹配。

在这一条记录的网关中填写接入互联网的路由器地址，当匹配不到其他路由时，网络包就会被转发到互联网接入路由器，因此这条记录也被称为**默认路由**。

### 3.3.6 包的有效期

从路由器中查询到转发目标之后，网络包就会被转交给输出端口，并最终发送出去。

第一个工作就是更新IP头部的**TTL(Time to Live)**,表示包的有效期，每经过一个路由器的转发，这个值就会减1，当这个值变成0的时候，就表示超过了有效期，这个包就会被丢弃。TTL的初始值一般是64或者128，地球上最多也只需要经过几十个路由器。

### 3.3.7 通过分片功能拆分大网络包

路由器的输出端口不只有以太网一种，也可以支持其他局域网或专线通信技术。

一旦转发的包的最大长度超过了输出端口能传输的最大长度，就需要使用IP协议中的分片功能对包进行拆分。

这里分片和TCP拆分数据有所不同，TCP拆分之后的数据正好装进一个包里，而分片则是将这一个包再次进行拆分。

拆分之前，还需要查看IP头部中的标志字段，确认是否可以分片，如果查询标志字段发现不能分片，那么就只能丢弃这个包，并通过ICMP消息通知发送方，否则，就可以按照输出端口MTU对数据进行一次拆分了。数据被 拆分后，每一份数据前面都会加上IP头部，大部分内容和以前一样，用于记录分片信息的部分发生了改变。

### 3.3.8 路由器的发送操作和计算机相同

在家庭网络中，路由器后面一般连接ADSL等线路接入互联网，因此路由器会根据接入网的规则来发送包。

但是假设输出端口也是以太网，那就按照以太网的规则来进行发送。

首先，判断MAC头部中的MAC地址应该填什么，需要根据路由表的网关列判断对方的地址。如果网关是一个IP地址，那么这个IP地址就是我们要转发的目标，如果网关为空（说明包可以直接发送到最终接收方），则IP头部中的IP地址就是我们要转发到的目标地址。

知道IP之后，接下来就是通过ARP根据IP地址查询MAC地址。

网络包完成后，会转换成电信号并通过端口发送出去。

如果输出端口为以太网，则发送出去的网络包会通过交换机到达下一个路由器，由于接收方MAC地址就是下一个路由器的地址，所以交换机会将包传输到下一个路由器，层层转发之后就到达目的地。

### 3.3.9 路由器与交换机

计算机在发送网络包的时候，都需要在前面加上MAC头部，相当于把IP包装进以太网包的数据部分中。

IP协议本身没有传输包的功能，因此包的传输是根据以太网来实现的。

路由器是基于IP设计的，交换机是基于以太网设计的。

IP（路由器）负责将包送达通信对象这一整体过程，而其中将包传输到下一个路由器的过程则是由以太网（交换机）来完成的。

## 3.4 路由器的附加功能

### 3.4.1 通过地址转换有效利用IP

由于互联网的快速发展，IP地址不够用了，假如公司A，B都有一个内网，且这两个内网是完全独立的，那么这两个内网有相同的IP地址也没有关系。

规定一些地址是用于内网的，这些地址叫作私有地址，而原来固定的地址叫做公有地址，私有地址的范围：

````
10.0.0.0 ~ 10.255.255.255
172.16.0.0 ~ 172.31.255.255
192.168.0.0 ~ 192.168.255.255
````

公司内网被分为两部分，一部分是 对互联网开放的服务器，另一部分是公司内部设备。其中对互联网开放的分配共有地址，可以和互联网直接通信，内部设备则分配私有地址，不能直接和互联网通信，而是要借助地址转换的机制。

### 3.4.2 地址转换的基本原理

地址转换的基本原理是在转发网络包的时候对IP头部中的IP地址和端口号进行改写。

改写前的私有地址和端口号，以及改写后的公有地址和端口号，会作为一组相对应的记录保存在地址转换设备内部的一张表中。（具有地址转换设备的不仅有路由器，有些防火墙也有地址转换的功能）。

从互联网来看，实际通信对象是地址转换设备。

### 3.4.3 改写端口号的原因

一个公有地址可以对应几万个私有地址，提高了公有地址的利用率。**（端口？）**

### 3.4.5 路由器的包过滤功能

包过滤就是在对包进行转发的时候，根据MAC头部，IP头部，TCP头部的内容，按照事先设置好的规则决定是转发这个包，还是丢弃这个包

